---
title: "A Data Investigation"
author: "Erin Buchanan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(rio)
library(dplyr)
library(tidyr)
```

## Data

```{r}
wave1 <- import("../Data Cleaning/Wave1Forecasts-Cleaned_2021-05-17.csv") %>% 
  select(team_name, Issue, Month.1:Month.12) %>% 
  rename(domain = Issue)
  
  
wave2 <- import("../Data Cleaning/Wave2Forecasts-Cleaned_2021-05-17.csv") %>% 
  select(team_name, domain, Month.1:Month.12) %>% 
  rename(Month.18 = Month.12,
  Month.17 = Month.11,
  Month.16 = Month.10,
  Month.15 = Month.9,
  Month.14 = Month.8,
  Month.13 = Month.7,
  Month.12 = Month.6,
  Month.11 = Month.5,
  Month.10 = Month.4,
  Month.9 = Month.3,
  Month.8 = Month.2,
  Month.7 = Month.1)

combined <- bind_rows(wave1, wave2) %>% 
  mutate(team_name = tolower(team_name),
         team_name = gsub("[[:punct:]]", "", team_name),
         team_name = gsub("revised", "", team_name),
         team_name = trimws(team_name))
# review and fix team names 
teams <- as.data.frame(table(combined$team_name))
# View(teams)
nrow(teams)
```

## Review Raw Scores

```{r}
teams <- unique(combined$team_name)

correl_matrix <- list()
correl_num <- list()
for (team in teams){
  temp <- combined %>% 
    filter(team_name == team) %>% 
    select(Month.1:Month.18)
  
  if (nrow(temp) > 2){
  correl_matrix[[team]] <- temp %>% 
    reframe(correl = cor(., use = "pairwise.complete.obs"))
  
  lower.triangle <- correl_matrix[[team]][lower.tri(as.matrix(correl_matrix[[team]]), diag = FALSE)]
  
  correl_num[[team]] <- sum(lower.triangle == 1, na.rm = TRUE)
  }
  
}
```

Should not have perfectly correlated monthly data: 

```{r}
correl_total <- bind_rows(correl_num) %>% 
  pivot_longer(cols = everything()) %>% 
  filter(value > 0)

nrow(correl_total)

length(correl_num) 

exclude <- correl_total$name
```

Number of decimals:

Given the author provided data, it's unclear how forecast teams entered their effect sizes (i.e., we do not have the excel sheets for each team, only the merged version with qualtrics). Potentially, we might see large numbers of decimals if they used code to model the outcome, but it's also odd to have precision to a large number of decimals per team. The data provided to members included up to 9 decimal places, so averages above this are odd. 

```{r}
decimalplaces <- function(x) {
  if (is.na(x)){ return(NA) } else {
  
    if (abs(x - round(x)) > .Machine$double.eps^0.5) {
        nchar(strsplit(sub('0+$', '', as.character(x)), ".", fixed = TRUE)[[1]][[2]])
    } else {
        return(0)
    }
  }
}

decimalinfo <- combined 
# a hack because mutate hates me
for (i in 1:nrow(decimalinfo)){
  decimalinfo$Month.1[i] <- decimalplaces(decimalinfo$Month.1[i])
  decimalinfo$Month.2[i] <- decimalplaces(decimalinfo$Month.2[i])
  decimalinfo$Month.3[i] <- decimalplaces(decimalinfo$Month.3[i])
  decimalinfo$Month.4[i] <- decimalplaces(decimalinfo$Month.4[i])
  decimalinfo$Month.5[i] <- decimalplaces(decimalinfo$Month.5[i])
  decimalinfo$Month.6[i] <- decimalplaces(decimalinfo$Month.6[i])
  decimalinfo$Month.7[i] <- decimalplaces(decimalinfo$Month.7[i])
  decimalinfo$Month.8[i] <- decimalplaces(decimalinfo$Month.8[i])
  decimalinfo$Month.9[i] <- decimalplaces(decimalinfo$Month.9[i])
  decimalinfo$Month.10[i] <- decimalplaces(decimalinfo$Month.10[i])
  decimalinfo$Month.11[i] <- decimalplaces(decimalinfo$Month.11[i])
  decimalinfo$Month.12[i] <- decimalplaces(decimalinfo$Month.12[i])
  decimalinfo$Month.13[i] <- decimalplaces(decimalinfo$Month.13[i])
  decimalinfo$Month.14[i] <- decimalplaces(decimalinfo$Month.14[i])
  decimalinfo$Month.15[i] <- decimalplaces(decimalinfo$Month.15[i])
  decimalinfo$Month.16[i] <- decimalplaces(decimalinfo$Month.16[i])
  decimalinfo$Month.17[i] <- decimalplaces(decimalinfo$Month.17[i])
  decimalinfo$Month.18[i] <- decimalplaces(decimalinfo$Month.18[i])
}
 
decimalinfo$team_decimal <- 
  apply(decimalinfo %>% 
        select(Month.1:Month.18), 1, mean, na.rm = T)

too_many <-
  decimalinfo %>% 
  filter(team_decimal > 9) %>% 
  select(team_name) %>% 
  unique()

nrow(too_many)

exclude <- c(exclude, too_many$team_name)
```

```{r}
# check 2 and 1 manually 
teams <- as.data.frame(table(combined$team_name)) %>% 
  filter(Freq < 3)

check <- combined %>% 
  filter(team_name %in% teams$Var1) 

check$sd <- apply(check %>% 
                    select(Month.1:Month.18), 1, sd, na.rm = T)

sum(check$sd == 0)

exclude <- c(exclude, check$team_name[check$sd == 0])
```

## Total Odd

```{r}
exclude <- unique(exclude)
length(exclude)

combined$exclude <- combined$team_name %in% exclude

export(combined, "reviewed_data.csv", row.names = F)
```

